name: Deploy to GCP


on:
  # Trigger when pushing to deploy branch
  push:
    branches:
      - 'deploy'
  
  # Also allow manual trigger
  workflow_dispatch:

jobs:
  # Run all tests first
  test:
    name: Run All Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.3'

    - name: Install dependencies
      working-directory: backend/src
      run: go mod tidy

    - name: Run all tests
      working-directory: backend/src
      run: go test -v ./...

  # Build Docker images
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test  # Only build if tests pass

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build backend image
      working-directory: backend
      run: docker build -f Dockerfile -t returnedft/tracking-status:test .

    - name: Build frontend image
      working-directory: frontend
      run: docker build -f Dockerfile -t returnedft/tracking-status-frontend:testfrontend .

    - name: Log build success
      run: |
        echo "Backend image built successfully"
        echo "Frontend image built successfully"

  # Deploy to GCP
  deploy-gcp:
    name: Deploy to GCP Cloud Run
    runs-on: ubuntu-latest
    needs: [test, build-docker]  # Only deploy if tests and builds pass

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker --quiet

    - name: Build and push backend image
      working-directory: backend
      run: |
        docker build -f Dockerfile -t returnedft/tracking-status:test .
        docker push returnedft/tracking-status:test

    - name: Build and push frontend image
      working-directory: frontend
      run: |
        docker build -f Dockerfile -t returnedft/tracking-status-frontend:testfrontend .
        docker push returnedft/tracking-status-frontend:testfrontend

    - name: Setup Terraform
      run: |
        wget -O /tmp/terraform.zip https://releases.hashicorp.com/terraform/1.5.0/terraform_1.5.0_linux_amd64.zip
        cd /tmp
        unzip -o terraform.zip
        chmod +x terraform
        sudo mv terraform /usr/local/bin/terraform
        terraform --version

    - name: Deploy with Terraform
      working-directory: terraform
      env:
        TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
        TF_VAR_docker_image: returnedft/tracking-status:test
        TF_VAR_frontend_docker_image: returnedft/tracking-status-frontend:testfrontend
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_blockchain_rpc_url: ${{ secrets.BLOCKCHAIN_RPC_URL }}
        TF_VAR_blockchain_private_key: ${{ secrets.BLOCKCHAIN_PRIVATE_KEY }}
        TF_VAR_blockchain_contract_address: ${{ secrets.BLOCKCHAIN_CONTRACT_ADDRESS }}
      run: |
        terraform init
        
        # Import existing resources if they exist (ignore errors if not found)
        terraform import -input=false google_sql_database_instance.postgres madeinportugal/tracking-db || true
        terraform import -input=false google_sql_database.database madeinportugal/tracking-db/tracking_db || true
        terraform import -input=false google_sql_user.user madeinportugal/tracking-db/tracking_user || true
        terraform import -input=false google_cloud_run_v2_service.default projects/madeinportugal/locations/europe-west1/services/tracking-status || true
        terraform import -input=false google_cloud_run_v2_service.frontend projects/madeinportugal/locations/europe-west1/services/tracking-status-frontend || true
        
        terraform apply -auto-approve

    - name: Run database migrations
      working-directory: backend
      run: |
        echo "Running database migrations on Cloud SQL..."
        
        # Get Cloud SQL instance public IP
        DB_IP=$(gcloud sql instances describe tracking-db --project=madeinportugal --format='value(ipAddresses[0].ipAddress)')
        
        # Install PostgreSQL client
        sudo apt-get update && sudo apt-get install -y postgresql-client
        
        # Run migrations using public IP
        PGPASSWORD="${{ secrets.DB_PASSWORD }}" psql \
          -h $DB_IP \
          -U tracking_user \
          -d tracking_db \
          -f db/migrations/001_init_schema.sql
        
        # Run seed data
        PGPASSWORD="${{ secrets.DB_PASSWORD }}" psql \
          -h $DB_IP \
          -U tracking_user \
          -d tracking_db \
          -f db/seeds/dev_data.sql
        
        echo "Database migrations completed successfully!"

    - name: Fix IAM bindings
      run: |
        gcloud run services add-iam-policy-binding tracking-status-frontend \
          --region=europe-west1 \
          --member=allUsers \
          --role=roles/run.invoker

    - name: Get service URLs
      run: |
        echo "Deployment successful"
        echo "Backend URL: $(gcloud run services describe tracking-status --region=europe-west1 --format='value(status.url)')"
        echo "Frontend URL: $(gcloud run services describe tracking-status-frontend --region=europe-west1 --format='value(status.url)')"

      