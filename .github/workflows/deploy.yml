name: Deploy to Google Cloud

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:

env:
  GCP_REGION: europe-west1
  TERRAFORM_VERSION: '1.6.0'

jobs:
  # ============================================================================
  # Backend Build & Deploy
  # ============================================================================
  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write

    outputs:
      backend_url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io

      - name: Build Docker image
        run: |
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/tracking-status:${{ github.sha }} \
                       -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/tracking-status:latest \
                       -f backend/Dockerfile \
                       backend/

      - name: Push Docker image
        run: |
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/tracking-status:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/tracking-status:latest

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init
        working-directory: ./backend/terraform

      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve -input=false \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ env.GCP_REGION }}" \
            -var="docker_image=gcr.io/${{ secrets.GCP_PROJECT_ID }}/tracking-status:${{ github.sha }}" \
            -var="db_password=${{ secrets.DB_PASSWORD }}" \
            -var="blockchain_bucket_name=${{ secrets.BLOCKCHAIN_BUCKET_NAME }}" \
            -var="environment=production"
        working-directory: ./backend/terraform

      - name: Get Service URL
        id: deploy
        run: |
          SERVICE_URL=$(terraform output -raw service_url)
          echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Backend deployed to: $SERVICE_URL"
        working-directory: ./backend/terraform

      - name: Run Database Migrations
        run: |
          # Wait for service to be ready
          sleep 30
          
          # Execute migrations (adjust based on your migration strategy)
          # This is a placeholder - implement your actual migration logic
          echo "Running database migrations..."
          # curl -X POST ${{ steps.deploy.outputs.url }}/api/v1/migrate

  # ============================================================================
  # Frontend Build & Deploy
  # ============================================================================
  deploy-frontend:
    name: Deploy Frontend to Cloud Run
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker gcr.io

      - name: Build Frontend Docker image
        env:
          NEXT_PUBLIC_API_URL: ${{ needs.deploy-backend.outputs.backend_url }}
        run: |
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/tracking-status-frontend:${{ github.sha }} \
                       -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/tracking-status-frontend:latest \
                       --build-arg NEXT_PUBLIC_API_URL=${{ needs.deploy-backend.outputs.backend_url }} \
                       -f frontend/Dockerfile \
                       frontend/

      - name: Push Frontend Docker image
        run: |
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/tracking-status-frontend:${{ github.sha }}
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/tracking-status-frontend:latest

      - name: Deploy Frontend to Cloud Run
        id: deploy-frontend
        run: |
          gcloud run deploy tracking-status-frontend \
            --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/tracking-status-frontend:${{ github.sha }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars="NEXT_PUBLIC_API_URL=${{ needs.deploy-backend.outputs.backend_url }}"
          
          FRONTEND_URL=$(gcloud run services describe tracking-status-frontend \
            --region ${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "Frontend deployed to: $FRONTEND_URL"

  # ============================================================================
  # Post-Deployment Tests
  # ============================================================================
  post-deployment-tests:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Backend Health
        run: |
          echo "Testing backend health endpoint..."
          curl -f ${{ needs.deploy-backend.outputs.backend_url }}/pong || exit 1

      - name: Test Blockchain Status
        run: |
          echo "Testing blockchain status..."
          curl -f ${{ needs.deploy-backend.outputs.backend_url }}/api/v1/blockchain/status || exit 1

      - name: Validate Blockchain Integrity
        run: |
          echo "Validating blockchain integrity..."
          RESULT=$(curl -s ${{ needs.deploy-backend.outputs.backend_url }}/api/v1/blockchain/validate)
          echo $RESULT
          if echo $RESULT | grep -q '"valid":true'; then
            echo "âœ… Blockchain integrity verified"
          else
            echo "âŒ Blockchain validation failed"
            exit 1
          fi

      - name: Create Deployment Summary
        run: |
          echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Deployed Services" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ needs.deploy-backend.outputs.backend_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Health Checks" >> $GITHUB_STEP_SUMMARY
          echo "- Backend API: âœ… Healthy" >> $GITHUB_STEP_SUMMARY
          echo "- Blockchain: âœ… Validated" >> $GITHUB_STEP_SUMMARY
