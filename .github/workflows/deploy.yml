name: Deploy to GCP

on:
  # Trigger when pushing to deploy branch
  push:
    branches:
      - 'deploy'
  
  # Also allow manual trigger
  workflow_dispatch:

jobs:
  # Run all tests first
  test:
    name: Run All Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.3'

    - name: Install dependencies
      working-directory: backend/src
      run: go mod tidy

    - name: Run all tests
      working-directory: backend/src
      run: go test -v ./...

  # Build Docker images
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test  # Only build if tests pass

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build backend image
      working-directory: backend
      run: docker build -f Dockerfile -t returnedft/tracking-status:test .

    - name: Build frontend image
      working-directory: frontend
      run: docker build -f Dockerfile -t returnedft/tracking-status-frontend:testfrontend .

    - name: Log build success
      run: |
        echo "Backend image built successfully"
        echo "Frontend image built successfully"

  # Deploy to GCP
  deploy-gcp:
    name: Deploy to GCP Cloud Run
    runs-on: ubuntu-latest
    needs: [test, build-docker]  # Only deploy if tests and builds pass

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for GCR
      run: gcloud auth configure-docker

    - name: Build and push backend image
      working-directory: backend
      run: |
        docker build -f Dockerfile -t returnedft/tracking-status:test .
        docker push returnedft/tracking-status:test

    - name: Build and push frontend image
      working-directory: frontend
      run: |
        docker build -f Dockerfile -t returnedft/tracking-status-frontend:testfrontend .
        docker push returnedft/tracking-status-frontend:testfrontend

    - name: Deploy with Terraform
      working-directory: terraform
      env:
        TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
        TF_VAR_blockchain_rpc_url: ${{ secrets.BLOCKCHAIN_RPC_URL }}
        TF_VAR_blockchain_private_key: ${{ secrets.BLOCKCHAIN_PRIVATE_KEY }}
      run: |
        terraform init
        terraform apply -auto-approve

    - name: Fix IAM bindings
      run: |
        gcloud run services add-iam-policy-binding tracking-status-frontend \
          --region=europe-west1 \
          --member=allUsers \
          --role=roles/run.invoker

    - name: Get service URLs
      run: |
        echo "Deployment successful"
        echo "Backend URL: $(gcloud run services describe tracking-status --region=europe-west1 --format='value(status.url)')"
        echo "Frontend URL: $(gcloud run services describe tracking-status-frontend --region=europe-west1 --format='value(status.url)')"

      